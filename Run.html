  function refreshInventory(){inventoryEl.innerHTML=''; for(let i=0;i<6;i++){const s=document.createElement('div');s.className='slot'; if(inventory[i]){s.textContent=inventory[i].type; s.draggable=true; s.dataset.index=i; s.addEventListener('dragstart',e=>{e.dataTransfer.setData('text/plain',i)})}
      inventoryEl.appendChild(s)} }
  refreshInventory();

  // Machine UI
  const machineUI=document.getElementById('machineUI');
  const machineSlotsEl=document.getElementById('machineSlots');
  const machineLog=document.getElementById('machineLog');
  const machineSlots=[null,null, null]; 
  function refreshMachineSlots(){machineSlotsEl.innerHTML=''; for(let i=0;i<3;i++){const slot=document.createElement('div');slot.className='slot';slot.style.width='72px';slot.style.height='72px';slot.dataset.index=i; if(machineSlots[i]){slot.textContent=machineSlots[i].type}
      slot.addEventListener('dragover',e=>e.preventDefault()); slot.addEventListener('drop',e=>{e.preventDefault();const fromIdx=parseInt(e.dataTransfer.getData('text/plain')); if(!isNaN(fromIdx) && inventory[fromIdx]){machineSlots[i]=inventory[fromIdx]; inventory.splice(fromIdx,1); refreshInventory(); refreshMachineSlots()}});
      machineSlotsEl.appendChild(slot)} }
  refreshMachineSlots();

  document.getElementById('convertBtn').addEventListener('click',()=>{
    for(let i=0;i<machineSlots.length;i++){const it=machineSlots[i]; if(!it) continue; if(it.type==='plastic'){machineLog.innerHTML+=("Plastic → Filament created!<br>");}
      else if(it.type==='metal'){machineLog.innerHTML+=("Metal → Ingot formed!<br>");}
      else if(it.type==='organic'){machineLog.innerHTML+=("Organic → Fuel refined!<br>");}
      machineSlots[i]=null;}
    refreshMachineSlots();
  });
  document.getElementById('backBtn').addEventListener('click',()=>{setMode('explore')});

  // Machine
  const machine=new THREE.Group();
  const machineBase=new THREE.Mesh(new THREE.BoxGeometry(3,1.2,1.5),new THREE.MeshStandardMaterial({color:'#333',metalness:0.2,roughness:0.6}));machineBase.position.y=0.6;machine.add(machineBase);
  const machineTop=new THREE.Mesh(new THREE.BoxGeometry(2.4,1.6,0.6),new THREE.MeshStandardMaterial({color:'#222',metalness:0.6,roughness:0.3}));machineTop.position.set(0,1.5,0);machine.add(machineTop);
  machine.position.set(12,0,0);scene.add(machine);

  // modes
  let mode='explore';
  function setMode(m){mode=m; if(m==='machine'){camera.position.set(12,3.2,6); camera.lookAt(12,1,0); machineUI.style.display='block'; document.getElementById('prompt').style.display='none';} else {camera.position.set(rover.position.x,8,rover.position.z+12);camera.lookAt(rover.position.x,0,rover.position.z); machineUI.style.display='none'; document.getElementById('prompt').style.display='block'} }
      
