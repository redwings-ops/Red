<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mars Rover Recycler — Single File Demo</title>
  <style>
    :root{--bg:#0e0b10;--panel:#111019;--accent:#ff6b35;--text:#e6e6e9}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#100717 0%, #0b0b12 100%);color:var(--text);font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,'Helvetica Neue',Arial}
    #gameWrap{display:grid;grid-template-columns:1fr 300px;gap:12px;padding:12px;height:100vh;box-sizing:border-box}
    .viewport{background:radial-gradient(ellipse at 20% 20%,#2a0f10 0%, #13080a 30%, #0b0610 100%);border-radius:12px;padding:12px;box-shadow:0 8px 30px rgba(0,0,0,0.7);position:relative;overflow:hidden}
    canvas{display:block;width:100%;height:100%;border-radius:8px}
    .panel{background:linear-gradient(180deg,#0f0c12,#0b0810);border-radius:12px;padding:16px;color:var(--text);box-shadow:inset 0 1px 0 rgba(255,255,255,0.02)}
    h1{margin:0;font-size:18px}
    .stats{margin-top:8px;font-size:14px;line-height:1.6}
    .controls{margin-top:12px;font-size:13px}
    .bar{height:10px;background:#171521;border-radius:6px;overflow:hidden;margin-top:8px}
    .bar > i{display:block;height:100%;background:linear-gradient(90deg,#ffb86b,#ff6b35);width:0}
    .centerHint{position:absolute;left:50%;transform:translateX(-50%);top:12px;background:rgba(255,255,255,0.03);padding:6px 10px;border-radius:8px;font-size:13px}
    footer{position:absolute;right:12px;bottom:12px;font-size:12px;color:rgba(230,230,233,0.6)}
    button.btn{background:var(--accent);color:#111;border:0;padding:8px 10px;border-radius:8px;font-weight:600;cursor:pointer}
    .inventory{display:flex;gap:8px;margin-top:8px}
    .invSlot{background:#0b0810;border:1px solid rgba(255,255,255,0.03);padding:10px;border-radius:8px;min-width:60px;text-align:center}
    .invSlot b{display:block;font-size:18px}
    /* MACHINE VIEW */
    #machineView{position:absolute;inset:0;background:linear-gradient(180deg,#071018,#02030a);display:none;align-items:center;justify-content:center}
    .machineCard{width:780px;height:420px;background:linear-gradient(180deg,#0b1116,#071018);border-radius:12px;padding:18px;box-shadow:0 12px 40px rgba(0,0,0,0.7);display:flex;gap:12px}
    .machineLeft{flex:1;padding:8px;border-right:1px solid rgba(255,255,255,0.03)}
    .machineRight{width:260px;padding:8px}
    .slot{height:70px;background:#0c0b10;border-radius:10px;display:flex;align-items:center;justify-content:center;margin-bottom:10px;border:2px dashed rgba(255,255,255,0.03)}
    .dropHint{font-size:13px;color:rgba(230,230,233,0.6)}
    .product{height:40px;padding:6px 10px;border-radius:8px;background:linear-gradient(90deg,#0d1116,#091017);display:inline-block;margin-right:6px}
    .machineActions{margin-top:10px}
    .resultRow{display:flex;gap:8px;align-items:center;margin-top:8px}
    .productOut{height:42px;padding:6px;border-radius:8px;background:#08111a;min-width:90px;text-align:center}
    /* responsive */
    @media (max-width:900px){#gameWrap{grid-template-columns:1fr;grid-auto-rows:1fr}}
  </style>
</head>
<body>
  <div id="gameWrap">
    <div class="viewport panel" id="playArea">
      <div class="centerHint">Use WASD / Arrow keys to move • Collect plastic, metal & organics • Press <b>E</b> near Machine to deposit</div>
      <canvas id="gameCanvas" width="1200" height="720"></canvas>
      <div id="machineView">
        <div class="machineCard">
          <div class="machineLeft">
            <h2 style="margin:0;color:#cfe7ff">Recycler — Load & Convert</h2>
            <p class="dropHint">Drag items from the inventory (right) into appropriate slots. Then press <b>Convert</b>.</p>
            <div id="slots">
              <div class="slot" data-type="plastic" id="slot-plastic">Plastic slot (filament)</div>
              <div class="slot" data-type="metal" id="slot-metal">Metal slot (ingot)</div>
              <div class="slot" data-type="organic" id="slot-organic">Organic slot (fuel)</div>
            </div>
            <div class="machineActions">
              <button id="convertBtn" class="btn">Convert</button>
              <button id="backBtn" class="btn" style="background:#666;color:#fff;margin-left:8px">Back</button>
            </div>
            <div id="results" style="margin-top:12px"></div>
          </div>
          <div class="machineRight">
            <h3 style="margin-top:0">Inventory</h3>
            <div id="invBox"></div>
            <p style="font-size:12px;color:rgba(230,230,233,0.6);margin-top:8px">Click an item to pick it for drag & drop. You may add multiples if you collected them.</p>
          </div>
        </div>
      </div>
      <footer>Prototype — Single-file HTML demo</footer>
    </div>

    <div class="panel">
      <h1>Mars Rover Recycler</h1>
      <div class="stats">
        <div>Collected:</div>
        <div class="inventory" id="hudInv">
          <div class="invSlot">Plastic <b id="pCount">0</b></div>
          <div class="invSlot">Metal <b id="mCount">0</b></div>
          <div class="invSlot">Organic <b id="oCount">0</b></div>
        </div>
        <div style="margin-top:10px">Energy:</div>
        <div class="bar"><i id="energyBar" style="width:100%"></i></div>
      </div>

      <div class="controls">
        <div style="margin-bottom:6px"><b>Objectives</b></div>
        <ol style="padding-left:18px;margin:0 0 10px 0;font-size:13px;color:rgba(230,230,233,0.85)">
          <li>Explore the surface and collect waste</li>
          <li>Deliver to the Recycler (building with antenna)</li>
          <li>Load & convert to useful products</li>
        </ol>
        <div style="display:flex;gap:8px"><button id="resetBtn" class="btn">Reset Game</button><button id="helpBtn" class="btn" style="background:#4477ff">How it works</button></div>
      </div>
    </div>
  </div>

  <script>
  // MarsRoverRecycler — single-file JS game (simple, extensible)
  const canvas = document.getElementById('gameCanvas');
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;

  // Game state
  let keys = {};
  let rover = {x:200,y:360,w:36,h:28,dir:0, speed:2.2, angle:0};
  let energy = 100;
  const hud = {plastic:0,metal:0,organic:0};
  const items = [];
  let machine = {x:1000,y:120,w:160,h:220};
  let mode = 'play'; // 'play' or 'machine'

  // generate random waste items on map
  function spawnItems(){
    items.length=0;
    for(let i=0;i<20;i++){
      const t = ['plastic','metal','organic'][Math.floor(Math.random()*3)];
      items.push({type:t,x:140+Math.random()*(W-300),y:100+Math.random()*(H-220),size:18+Math.random()*8,col: t==='plastic'? '#b3fffc': t==='metal'? '#c0c7ff':'#ffd3a6' });
    }
  }

  spawnItems();

  // draw simple procedural terrain texture
  function drawTerrain(){
    // sky
    const g = ctx.createLinearGradient(0,0,0,H);
    g.addColorStop(0,'#2a0b10'); g.addColorStop(1,'#15060a');
    ctx.fillStyle = g; ctx.fillRect(0,0,W,H);

    // ground patches
    for(let i=0;i<70;i++){
      ctx.fillStyle = `rgba(255,255,255,${Math.random()*0.03})`;
      ctx.beginPath();
      const rx = Math.random()*W, ry = H*0.6+Math.random()*H*0.35, rw=30+Math.random()*120, rh=6+Math.random()*30;
      ctx.ellipse(rx,ry,rw,rh,Math.random()*Math.PI,0,Math.PI*2); ctx.fill();
    }
  }

  // rover render
  function drawRover(){
    ctx.save();
    ctx.translate(rover.x,rover.y);
    ctx.rotate(rover.angle);
    // body
    ctx.fillStyle = '#c7c9d0'; ctx.fillRect(-18,-12,36,24);
    // texture stripes
    ctx.fillStyle = 'rgba(0,0,0,0.06)'; ctx.fillRect(-18,-6,36,3);
    // wheels
    for(let wx of [-14,14]){
      ctx.beginPath(); ctx.ellipse(wx,14,6,8,0,0,Math.PI*2); ctx.fillStyle='#222'; ctx.fill();
      ctx.fillStyle='#333'; ctx.fillRect(wx-6,11,12,4);
    }
    // antenna
    ctx.strokeStyle='#111'; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(10,-12); ctx.lineTo(16,-20); ctx.stroke();
    // solar panel / texture
    ctx.fillStyle='#223344'; ctx.fillRect(-14,-16,10,6);
    ctx.restore();
  }

  // draw items
  function drawItems(){
    for(const it of items){
      ctx.save();
      ctx.translate(it.x,it.y);
      // subtle shadow
      ctx.beginPath(); ctx.ellipse(0,10,it.size*0.9,6,0,0,Math.PI*2); ctx.fillStyle='rgba(0,0,0,0.18)'; ctx.fill();
      // item circle
      ctx.beginPath(); ctx.arc(0,0,it.size,0,Math.PI*2); ctx.fillStyle=it.col; ctx.fill();
      ctx.fillStyle='rgba(0,0,0,0.06)'; ctx.fillRect(-it.size,0,it.size*2,2);
      ctx.restore();
    }
  }

  // machine render
  function drawMachine(){
    ctx.save();
    ctx.translate(machine.x,machine.y);
    // base
    ctx.fillStyle='#22303b'; ctx.fillRect(0,0,machine.w,machine.h);
    // antenna
    ctx.fillStyle='#99d2ff'; ctx.fillRect(8,-40,6,40);
    // loading bay
    ctx.fillStyle='#2a3a44'; ctx.fillRect(20,machine.h-80,machine.w-40,60);
    ctx.fillStyle='rgba(255,255,255,0.02)'; ctx.fillRect(20,machine.h-80,machine.w-40,2);
    // label
    ctx.fillStyle='#cfe7ff'; ctx.font='14px sans-serif'; ctx.fillText('RECYCLER',10,machine.h+18);
    ctx.restore();
  }

  // HUD
  function drawHUD(){
    // mini rover
    ctx.save(); ctx.fillStyle='rgba(255,255,255,0.02)'; ctx.fillRect(12,12,200,64); ctx.restore();
  }

  // core loop
  function update(){
    // movement
    let dx=0,dy=0;
    if(keys['ArrowUp']||keys['w']) dy-=1;
    if(keys['ArrowDown']||keys['s']) dy+=1;
    if(keys['ArrowLeft']||keys['a']) dx-=1;
    if(keys['ArrowRight']||keys['d']) dx+=1;
    if(dx||dy){
      const len=Math.hypot(dx,dy); dx/=len; dy/=len;
      rover.x += dx*rover.speed; rover.y += dy*rover.speed;
      rover.angle = Math.atan2(dy,dx);
      energy = Math.max(0, energy - 0.02);
    }
    // bounds
    rover.x = Math.max(30,Math.min(W-30,rover.x)); rover.y = Math.max(30,Math.min(H-30,rover.y));

    // pickup
    for(let i=items.length-1;i>=0;i--){
      const it = items[i];
      const d = Math.hypot(it.x-rover.x, it.y-rover.y);
      if(d < 28){
        // collect
        hud[it.type]++;
        items.splice(i,1);
        // small beep (visual)
        flashPick(it.type);
      }
    }

    // update HUD elements
    document.getElementById('pCount').innerText = hud.plastic;
    document.getElementById('mCount').innerText = hud.metal;
    document.getElementById('oCount').innerText = hud.organic;
    document.getElementById('energyBar').style.width = Math.max(0,energy)+'%';

    // if near machine and press E -> go to machine mode
    if(Math.hypot(rover.x-(machine.x+machine.w/2), rover.y-(machine.y+machine.h/2)) < 120 && (keys['e']||keys['E'])){
      openMachineView();
    }
  }

  let pickFlash = null;
  function flashPick(type){ pickFlash = {t:0,type}; setTimeout(()=>pickFlash=null,350); }

  function render(){
    ctx.clearRect(0,0,W,H);
    drawTerrain();
    drawItems();
    drawMachine();
    drawRover();

    // pickup flash
    if(pickFlash){
      ctx.save(); ctx.globalAlpha = 0.9 - pickFlash.t*2; ctx.fillStyle='white'; ctx.font='20px sans-serif'; ctx.fillText('+'+pickFlash.type.toUpperCase(), rover.x+30, rover.y-10); ctx.restore();
      pickFlash.t += 0.02;
    }

    // proximity hint
    const near = Math.hypot(rover.x-(machine.x+machine.w/2), rover.y-(machine.y+machine.h/2)) < 120;
    if(near){
      ctx.save(); ctx.fillStyle='rgba(255,255,255,0.06)'; ctx.fillRect(machine.x-8,machine.y-10,machine.w+16,machine.h+20);
      ctx.fillStyle='#cfe7ff'; ctx.font='14px sans-serif'; ctx.fillText('Press E to access Recycler', machine.x-12, machine.y-18); ctx.restore();
    }
  }

  // game loop
  function loop(){ if(mode==='play'){ update(); render(); } requestAnimationFrame(loop); }
  loop();

  // controls
  window.addEventListener('keydown', e=>{ keys[e.key]=true; if(e.key===' '){ e.preventDefault(); } });
  window.addEventListener('keyup', e=>{ keys[e.key]=false; });

  // reset
  document.getElementById('resetBtn').addEventListener('click', ()=>{ hud.plastic=0; hud.metal=0; hud.organic=0; energy=100; spawnItems(); });
  document.getElementById('helpBtn').addEventListener('click', ()=>{ alert('Collect items on the map. Approach the big Recycler (right side) and press E. In machine view you can drag inventory items into slots and Convert them into products.'); });

  // Machine view behaviour
  const machineView = document.getElementById('machineView');
  const invBox = document.getElementById('invBox');
  function openMachineView(){
    mode='machine'; machineView.style.display='flex'; buildInventoryDOM();
  }
  document.getElementById('backBtn').addEventListener('click', ()=>{ closeMachineView(); });
  function closeMachineView(){ mode='play'; machineView.style.display='none'; }

  // build inventory items as draggable DOM
  function buildInventoryDOM(){
    invBox.innerHTML='';
    ['plastic','metal','organic'].forEach(type=>{
      const count = hud[type];
      for(let i=0;i<count;i++){
        const div = document.createElement('div'); div.className='product'; div.draggable=true; div.innerText = type+ (count>1? '':''); div.dataset.type=type;
        div.addEventListener('dragstart', (ev)=>{ ev.dataTransfer.setData('text/plain', type); });
        invBox.appendChild(div);
      }
    });
  }

  // slots drag/drop
  document.querySelectorAll('.slot').forEach(s=>{
    s.addEventListener('dragover', e=>{ e.preventDefault(); s.style.borderColor = 'rgba(255,255,255,0.12)'; });
    s.addEventListener('dragleave', e=>{ s.style.borderColor='rgba(255,255,255,0.03)'; });
    s.addEventListener('drop', e=>{
      e.preventDefault(); s.style.borderColor='rgba(255,255,255,0.03)'; const type = e.dataTransfer.getData('text/plain');
      // create a small tag in slot
      s.innerHTML = `<div class="productOut">${type.toUpperCase()}</div>`;
      s.dataset.loaded = type;
      // decrement hud (one item consumed into slot preview)
      hud[type] = Math.max(0, hud[type]-1);
      document.getElementById('pCount').innerText=hud.plastic; document.getElementById('mCount').innerText=hud.metal; document.getElementById('oCount').innerText=hud.organic;
    });
  });

  document.getElementById('convertBtn').addEventListener('click', ()=>{
    const slots = ['slot-plastic','slot-metal','slot-organic'].map(id=>document.getElementById(id));
    const results = [];
    slots.forEach(s=>{ if(s.dataset.loaded){
      if(s.dataset.loaded==='plastic') results.push({type:'Filament',qty:1});
      if(s.dataset.loaded==='metal') results.push({type:'Ingot',qty:1});
      if(s.dataset.loaded==='organic') results.push({type:'Fuel',qty:1});
      // clear slot
      s.dataset.loaded=''; s.innerHTML = s.getAttribute('data-type') + ' slot ('+ (s.getAttribute('data-type')==='plastic'? 'filament': s.getAttribute('data-type')==='metal'? 'ingot':'fuel') +')';
    }});
    showResults(results);
  });

  function showResults(results){
    const out = document.getElementById('results'); out.innerHTML='';
    if(results.length===0) { out.innerHTML='<div style="color:rgba(255,255,255,0.6)">No materials loaded.</div>'; return; }
    for(const r of results){
      const d = document.createElement('div'); d.className='resultRow'; d.innerHTML = `<div class='productOut'>${r.type}</div><div style='font-size:13px;color:rgba(255,255,255,0.8)'>Produced x${r.qty}</div>`;
      out.appendChild(d);
    }
    // add small reward — energy boost
    energy = Math.min(100, energy+15);
  }

  // keep inventory DOM in sync when opening machine (also allow clicking to add items into inv if user prefers)
  invBox.addEventListener('click', e=>{
    const t = e.target.dataset.type; if(!t) return; if(hud[t]>0) { /* do nothing, drag exists */ }
  });

  // small responsive scaling
  function resizeCanvas(){
    const rect = canvas.getBoundingClientRect(); const scaleW = rect.width; const scaleH = rect.height;
    // we keep internal resolution fixed (1200x720) for consistent drawing
  }
  window.addEventListener('resize', resizeCanvas);

  </script>
</body>
</html>
